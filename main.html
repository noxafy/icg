<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<title>ICG - Gruppe 20</title>

	<link rel="stylesheet" href="main.css" type="text/css">
</head>

<body>

<div id="canvas-container">
	<canvas id="rasteriser" width="1920" height="1080"></canvas>
	<div class="disabled" id="specs-view">fps:
		<fps id="fps"></fps>
	</div>
	<script src="animation/animation-nodes.js"></script>
	<script src="animation/animator.js"></script>
	<script src="animation/driver.js"></script>
	<script src="animation/jumper.js"></script>
	<script src="animation/rotor.js"></script>
	<script src="maths/matrix.js"></script>
	<script src="maths/utils.js"></script>
	<script src="maths/vector.js"></script>
	<script src="shader/raster-box.js"></script>
	<script src="shader/raster-sphere.js"></script>
	<script src="shader/raster-texture-box.js"></script>
	<script src="scene/nodes.js"></script>
	<script src="scene/visitor.js"></script>
	<script src="scene/material.js"></script>
	<script src="shader/shader.js"></script>
	<script src="resources/materials.js"></script>
	<script src="interaction.js"></script>
	<script src="preferences.js"></script>
	<script src="specsView.js"></script>
	<script>
		// set up canvas
		const aspectW = 16;
		const aspectH = 9;
		const aspectResolution = 120;

		// init canvas
		window.aspect = aspectW / aspectH;
		const canvas = document.getElementById("rasteriser");
		canvas.setAttribute("width", aspectW * aspectResolution);
		canvas.setAttribute("height", aspectH * aspectResolution);
		const container = document.getElementById("canvas-container");
		window.onresize = function () {
			let s = Math.min(window.innerWidth / aspectW, window.innerHeight / aspectH);
			container.style.width = s * aspectW + "px";
			container.style.height = s * aspectH + "px";
		}
		window.onresize();

		// construct scene graph
		let camera = new CameraNode(
			new Vector(0, 0, 10, 1), // eye
			new Vector(0, 0, 9, 1), // center
			new Vector(0, 1, 0, 0), // up
			0.1, 100, 60 // near, far, fovy
		)

		const sphere = new SphereNode(new Vector(.5, -.8, 0, 1), 0.4, new Vector(.8, .4, .1, 1), Materials.bronze);
		const jumpingSphere = new SphereNode(new Vector(0, 0, 0, 1), 0.4, new Vector(0, 0, 0, 1), Materials.chrome);
		const light = new LightNode(new Vector(-5.0, 2.0, -10.0, 1), new Vector(1, 1, 1), 1)
		const lightSphere = new SphereNode(light.position, 0.2, new Vector(0, 0, 0), Materials.blank)
		const cube = new TextureBoxNode(
			new Vector(-1, -1, -1, 1),
			new Vector(1, 1, 1, 1),
			'resources/hci-logo.png'
		);

		//      sg
		//     /  \
		//  gn1:Tc gn5:Tl - jumpingSphere
		//   /   \
		// gn2:Ts gn3
		//   |      \
		// gn4:T-c cube
		//   |
		// sphere

		const sg = new GroupNode(Matrix.identity())
		const gn1 = new GroupNode(Matrix.translation(new Vector(-.3, -0.4, .1))); // Tc
		const gn3 = new GroupNode(Matrix.identity());
		const gn2 = new GroupNode(Matrix.translation(new Vector(1, 1, 0))); // Ts
		const gn4 = new GroupNode(Matrix.translation(new Vector(.3, .4, -.1))); // -Tc
		const gn5 = new GroupNode(Matrix.translation(new Vector(-3.5, -2.5, -5.0, 1))); // Tl
		const gn6 = new GroupNode(Matrix.identity());
		const gn7 = new GroupNode(Matrix.identity());

		sg.add(gn1);
		gn1.add(gn2);
		gn2.add(gn4);
		gn4.add(sphere);

		gn1.add(gn3);
		gn3.add(cube);

		sg.add(gn5);
		gn5.add(jumpingSphere);

		sg.add(gn6);
		gn6.add(camera);

		sg.add(gn7);
		gn7.add(light);
		gn7.add(lightSphere)

		// add animation nodes
		window.animationNodes = [
			new AnimationNode(gn1, new Rotor(new Vector(0, 0, 1), 30)),
			new AnimationNode(gn5, new PhysicsJumper(new Vector(0, 3, 0), 1)),
			new AnimationNode(gn7, new Driver2D(3)),
			new AnimationNode(gn6, new FreeFlight(3)),
		];

		function simulate(deltaT) {
			for (let animationNode of animationNodes) {
				animationNode.simulate(deltaT);
			}
		}

		// setup for rendering
		const gl = canvas.getContext("webgl");
		const setupVisitor = new RasterSetupVisitor(gl);
		setupVisitor.setup(sg);

		const phongShader = new Shader(gl,
			"shader/phong-vertex-perspective-shader.glsl",
			"shader/phong-fragment-shader.glsl"
		);
		const textureShader = new Shader(gl,
			"shader/texture-vertex-perspective-shader.glsl",
			"shader/texture-fragment-shader.glsl"
		);
		const visitor = new RasterVisitor(gl, phongShader, textureShader);

		// do animation as soon as shader are loaded
		Promise.all(
			[phongShader.load(), textureShader.load()]
		).then(x =>
			window.requestAnimationFrame(animate)
		);

		let lastTimestamp = performance.now();
		function animate(timestamp) {
			let deltaT = timestamp - lastTimestamp;
			if (Preferences.showSpecs) SpecsView.FPS.add(deltaT);
			simulate(deltaT);
			visitor.render(sg);
			lastTimestamp = timestamp;
			window.requestAnimationFrame(animate);
		}
	</script>
</div>
</body>

</html>