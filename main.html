<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8"/>
	<title>ICG - Gruppe 20</title>

	<link rel="stylesheet" href="main.css" type="text/css">

	<script src="math/matrix.js"></script>
	<script src="math/utils.js"></script>
	<script src="math/vector.js"></script>
	<script src="model/color.js"></script>
	<script src="model/node/animation-node.js"></script>
	<script src="model/animator/animator.js"></script>
	<script src="model/animator/driver.js"></script>
	<script src="model/animator/jumper.js"></script>
	<script src="model/animator/rotor.js"></script>
	<script src="model/material.js"></script>
	<script src="model/node/node.js"></script>
	<script src="model/node/lightableNode.js"></script> <!--must be after node.js-->
	<script src="model/visitor.js"></script>
	<script src="model/renderer.js"></script>
	<script src="rasterizer/shape/raster-shape.js"></script>
	<script src="rasterizer/shape/raster-box.js"></script>
	<script src="rasterizer/shape/raster-sphere.js"></script>
	<script src="rasterizer/shape/raster-texture-box.js"></script>
	<script src="rasterizer/shape/raster-pyramid.js"></script>
	<script src="rasterizer/shape/raster-cone.js"></script>
	<script src="rasterizer/shader/shader.js"></script>
	<script src="rasterizer/raster-visitor.js"></script>
	<script src="rasterizer/raster-setup-visitor.js"></script>
	<script src="rasterizer/raster-renderer.js"></script>
	<script src="raytracer/shape/sphere.js"></script>
	<script src="raytracer/shape/aabox.js"></script>
	<script src="raytracer/camera.js"></script>
	<script src="raytracer/intersection.js"></script>
	<script src="raytracer/phong.js"></script>
	<script src="raytracer/ray.js"></script>
	<script src="raytracer/raytracing-renderer.js"></script>
	<script src="raytracer/raytracing-visitor.js"></script>
	<script src="resources/materials.js"></script>
	<script src="resources/colors.js"></script>
	<script src="renderProcess.js"></script>
	<script src="interaction.js"></script>
	<script src="io/scenegraph-exporter.js"></script>
	<script src="io/scenegraph-importer.js"></script>
</head>

<body>

<div id="canvas-container">
	<div class="disabled" id="specs-view">
		<div id="fps">fps: <div id="fps_val"></div></div>
		<div id="light_props">
			<div id="light_props_header">
				<label for="lights" id="light_props_title">Light properties </label>
				<select id="lights" oninput="(function(val) {
							if(val === 'default') {
								SpecsView.LightChanger.disable();
							} else {
								SpecsView.LightChanger.enable(window.renderProcess.renderer.lights[val]);
							}
						})(this.value)">
					<option>Please choose a light...</option>
				</select>
			</div>
			<div class="disabled" id="light_props_sliders"></div>
		</div>
	</div>
	<div class="disabled" id="menu-view">
		<button id="sg-export-btn"
				onclick="(function onclick(btn) {
					btn.innerText='';
					btn.className='loading-button';
					SceneGraphExporter.export(sg, animationNodes);
				})(this);">
			Export Scenegraph
		</button>
		<div id="import-request">Drop a .json file for importing.</div>
	</div>
	<canvas id="rasterizer" width="1920" height="1080"></canvas>
	<canvas class="disabled" id="raytracer" width="500" height="500"></canvas>

	<script src="preferences.js"></script>
	<script src="specsView.js"></script>
	<script src="menuView.js"></script>
	<script>
		// set up canvas
		const aspectW = 16;
		const aspectH = 16;
		const aspectResolution = 120;

		// init rasterizer canvas
		let canvas = document.getElementById("rasterizer");
		canvas.setAttribute("width", aspectW * aspectResolution);
		canvas.setAttribute("height", aspectH * aspectResolution);

		// init canvas container
		const container = document.getElementById("canvas-container");
		window.onresize = function () {
			let s = Math.min(window.innerWidth / aspectW, window.innerHeight / aspectH);
			container.style.width = s * aspectW + "px";
			container.style.height = s * aspectH + "px";
		}
		window.onresize();

		// construct scene graph
		let camera = new CameraNode(
			new Vector(0, -0.5, -1), // direction
			aspectW / aspectH,
			0.1, 100, 60 // near, far, fovy
		)

		const sphere = new SphereNode(new Position(0, 0, 0), 0.4, Colors.GOLD, Materials.GOLD);
		const jumpingSphere = new SphereNode(new Position(0, 0, 0), 0.4, Colors.BLACK, Materials.CHROME);
		const light = new LightNode(new Position(-5.0, 2.0, -10.0), Colors.WHITE, 1.2, 0.8, 0.02, 0.001);
		const lightSphere = new SphereNode(light.position, 0.2, Colors.YELLOW, Materials.BLANK);
		const hci_cube = new TextureBoxNode(
			new Position(-1, -1, -1),
			new Position(1, 1, 1),
			'resources/textures/hci-logo.png'
		);
		const cube = new AABoxNode(new Position(-1, -1, -1), new Position(1, 1, 1), Colors.LIMEGREEN, Materials.EMERALD);
		const pyramid = new PyramidNode(2, 2, 2, Colors.ORANGERED, Materials.BRASS);
		const cone = new ConeNode(1, 2, Colors.LIGHTGOLDENRODYELLOW, Materials.COPPER);

		//      sg
		//     /  \
		//  gn1:Tc gn5:Tl - jumpingSphere
		//   /   \
		// gn2:Ts gn3
		//   |      \
		// gn4:T-c hci_cube
		//   |
		// sphere

		window.sg = new GroupNode(Matrix.identity())
		const gn1 = new GroupNode(Matrix.translation(new Vector(-.3, -0.4, .1))); // Tc
		const gn3 = new GroupNode(Matrix.identity());
		const gn2 = new GroupNode(Matrix.translation(new Vector(-4, -1, -2))); // Ts
		const gn5 = new GroupNode(Matrix.translation(new Vector(-3.5, -2.5, -5.0))); // Tl
		const gn6 = new GroupNode(Matrix.translation(new Vector(-4, 5, 10)));
		const gn7 = new GroupNode(Matrix.identity());
		const gn8 = new GroupNode(Matrix.translation(new Vector(-5, -1, 0)));
		const gn9 = new GroupNode(Matrix.translation(new Vector(-9, -1, 0)));

		sg.add(gn1);

		gn1.add(gn3);
		gn3.add(hci_cube);
		gn1.add(gn2);
		gn2.add(sphere);

		sg.add(gn5);
		gn5.add(jumpingSphere);

		sg.add(gn6);
		gn6.add(camera);

		sg.add(gn7);
		gn7.add(light);
		gn7.add(lightSphere)

		// sg.add(gn8);
		// gn8.add(cube);

		sg.add(gn9);
		// gn9.add(pyramid);
		gn9.add(cone);

		// add animation nodes
		window.animationNodes = [
			// new AnimationNode(gn1, new Rotor(new Vector(0, 0, 1), 30)),
			new AnimationNode(gn1, new AxisAlignedRotor(60)),
			new AnimationNode(gn5, new PhysicsJumper(new Vector(0, 3, 0), 1)),
			new AnimationNode(gn7, new Driver2D(6)),
			new AnimationNode(gn6, new FreeFlight(4, camera.up))
		];

		// start render process
		window.renderProcess = new RenderProcess();
		window.run = function (timestamp) {
			if (!renderProcess.onStop) {
				let deltaT = timestamp - window.renderProcess.lastTimestamp;
				if (Preferences.showSpecs) SpecsView.FPS.add(deltaT);
				simulate(deltaT);
				window.renderProcess.renderer.render(window.sg);
				window.renderProcess.lastTimestamp = timestamp;
				window.requestAnimationFrame(window.run);
			} else {
				window.renderProcess.onStop();
			}

			function simulate(deltaT) {
				for (let animationNode of window.animationNodes) {
					animationNode.simulate(deltaT);
				}
			}
		}
		Preferences.toggleRenderer();
		window.renderProcess.onStop();

		UserInteraction.init();
		UserInteraction.onFileDropped((file) => {
			window.renderProcess.stop(() => {
				// only take account of the first file
				let reader = new FileReader();
				reader.onload = function (res) {
					let result = SceneGraphImporter.load(res.target.result);
					if (result) {
						window.sg = result.sg;
						window.animationNodes = result.animationNodes;
					} else {
						console.log("Couldn't load file: " + file.name);
					}
					window.renderProcess = new RenderProcess();
					window.renderProcess.start();
				}
				reader.readAsText(file);
			});
		});
	</script>
</div>
</body>

</html>